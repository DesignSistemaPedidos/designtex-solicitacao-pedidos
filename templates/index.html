<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Solicita√ß√£o de Pedido de Vendas - Designtex Tecidos</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>

  <style>
    body {
      background-color: #80858b;
      font-family: 'Arial', sans-serif;
    }
    .container {
      background-color: white;
      border-radius: 15px;
      padding: 30px;
      margin: 20px auto;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      max-width: 1000px;
    }
    .header-title {
      color: #1a5490;
      text-align: center;
      font-weight: bold;
      margin-bottom: 30px;
      font-size: 28px;
    }
    /* Autocomplete */
    .autocomplete-container { position: relative; }
    .autocomplete-dropdown {
      position: absolute; top: 100%; left: 0; right: 0;
      background: white; border: 1px solid #ddd; border-top: none;
      max-height: 200px; overflow-y: auto; z-index: 1000; display: none;
    }
    .autocomplete-item { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; font-size: 14px; }
    .autocomplete-item:hover { background-color: #f5f5f5; }
    .btn-primary { background-color: #1a5490; border-color: #1a5490; }
    .btn-primary:hover { background-color: #134072; border-color: #134072; }
    .btn-voltar {
      background-color: #6c757d; color: white; text-decoration: none;
      padding: 8px 16px; border-radius: 5px; margin-bottom: 20px; display: inline-block;
    }
    .btn-voltar:hover { background-color: #5a6268; color: white; text-decoration: none; }
    @media (max-width: 768px) {
      .container { margin: 10px; padding: 20px; }
      .header-title { font-size: 22px; }
    }
  </style>
</head>

<body>
  <div class="container">
    <a href="/" class="btn-voltar">‚¨ÖÔ∏è Voltar ao In√≠cio</a>

    <h1 class="header-title">SOLICITA√á√ÉO DE PEDIDO DE VENDAS<br/>DESIGNTEX TECIDOS</h1>

    <form id="pedidoForm">
      <!-- PARTE 1 - CABE√áALHO -->
      <div class="card mb-4">
        <div class="card-header" style="background-color:#1a5490;color:#fff;">
          <h5 class="mb-0">üìã DADOS DO CABE√áALHO</h5>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label for="nomeRepresentante" class="form-label">Nome do Representante *</label>
              <input type="text" class="form-control" id="nomeRepresentante" required />
            </div>

            <div class="col-md-6">
              <label for="razaoSocial" class="form-label">Raz√£o Social do Cliente *</label>
              <div class="autocomplete-container">
                <input type="text" class="form-control" id="razaoSocial" placeholder="Digite para buscar..." required />
                <div id="autocomplete-dropdown" class="autocomplete-dropdown"></div>
              </div>
            </div>

            <div class="col-md-6">
              <label for="cnpj" class="form-label">CNPJ do Cliente *</label>
              <input type="text" class="form-control" id="cnpj" readonly style="background-color:#f8f9fa;" />
            </div>

            <div class="col-md-6">
              <label for="telefone" class="form-label">Telefone de Contato *</label>
              <input type="text" class="form-control" id="telefone" required />
            </div>
          </div>
        </div>
      </div>

      <!-- PARTE 2 - CONDI√á√ïES -->
      <div class="card mb-4">
        <div class="card-header" style="background-color:#1a5490;color:#fff;">
          <h5 class="mb-0">‚öôÔ∏è CONDI√á√ïES DO PEDIDO</h5>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label for="prazoPagamento" class="form-label">Prazo de Pagamento *</label>
              <select class="form-select" id="prazoPagamento" required>
                <option value="">Selecione...</option>
                <option>√Ä vista</option>
                <option>7 dias</option>
                <option>14 dias</option>
                <option>21 dias</option>
                <option>28 dias</option>
                <option>21/28/35 dias</option>
                <option>35/42/49 dias</option>
                <option>28/35/42/49/56 dias</option>
                <option>49/56/63 dias</option>
                <option>42/49/56/63/70 dias</option>
                <option>56/63/70/77/84 dias</option>
                <option>28/56/84/112/140 dias</option>
                <option>56/70/84/98/112 dias</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <!-- PARTE 3 - TABELA DE PRE√áOS -->
      <div class="card mb-4">
        <div class="card-header" style="background-color:#1a5490;color:#fff;">
          <h5 class="mb-0">üí∞ TABELA DE PRE√áOS</h5>
        </div>
        <div class="card-body">
          <div class="border p-3 rounded">
            <div class="form-check">
              <input class="form-check-input" type="radio" id="icms7" name="tabelaPrecos" value="ICMS 7%" required>
              <label for="icms7" class="form-check-label me-3">ICMS 7%</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" id="icms12" name="tabelaPrecos" value="ICMS 12%" required>
              <label for="icms12" class="form-check-label me-3">ICMS 12%</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" id="icms18" name="tabelaPrecos" value="ICMS 18%" required>
              <label for="icms18" class="form-check-label me-3">ICMS 18%</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" id="retmg" name="tabelaPrecos" value="RET (SOMENTE MG)" required>
              <label for="retmg" class="form-check-label me-3">RET (SOMENTE MG)</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" id="precosld" name="tabelaPrecos" value="PRE√áOS LD (GERAL)" required>
              <label for="precosld" class="form-check-label">PRE√áOS LD (GERAL)</label>
            </div>
            <small class="text-muted d-block mt-2">Selecione apenas uma op√ß√£o.</small>
          </div>
        </div>
      </div>

      <!-- PARTE 4 - PRODUTOS -->
      <div class="card mb-4">
        <div class="card-header" style="background-color:#1a5490;color:#fff;">
          <h5 class="mb-0">üì¶ PRODUTOS</h5>
        </div>
        <div class="card-body">
          <div id="produtos-container"></div>
          <button type="button" class="btn btn-secondary mb-3" onclick="adicionarProduto()">‚ûï Adicionar Produto</button>
          <div class="text-end">
            <h4>Total: R$ <span id="valorTotal">0.00</span></h4>
          </div>
        </div>
      </div>

      <!-- PARTE 5 - OBSERVA√á√ïES -->
      <div class="card mb-4">
        <div class="card-header" style="background-color:#1a5490;color:#fff;">
          <h5 class="mb-0">üìù OBSERVA√á√ïES</h5>
        </div>
        <div class="card-body">
          <textarea class="form-control" id="observacoes" rows="4" maxlength="500" placeholder="Observa√ß√µes adicionais (m√°ximo 500 caracteres)"></textarea>
          <div class="form-text"><span id="contadorCaracteres">0</span>/500 caracteres</div>
        </div>
      </div>

      <!-- BOT√ïES -->
      <div class="d-grid gap-2 d-md-flex justify-content-md-end">
        <button type="submit" class="btn btn-primary btn-lg me-md-2">üì§ Enviar Pedido</button>
        <button type="button" class="btn btn-secondary btn-lg" onclick="limparFormulario()">üóëÔ∏è Cancelar</button>
      </div>
    </form>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Script Aplica√ß√£o -->
  <script>
    // ============================= VARI√ÅVEIS =============================
    let contadorProdutos = 0;
    let listaArtigosComPrecos = [];
    let tipoPrecoAtual = ""; // icms_7 | icms_12 | icms_18 | ret_mg | ld
    let timeoutId = null;    // autocomplete debounce

    // ============================= HELPERS =============================
    function getVal(id) {
      const el = document.getElementById(id);
      return el ? el.value : "";
    }

    // ============================= ARTIGOS/PRE√áOS =============================
    function carregarArtigosDoBanco(callback) {
      fetch('/api/artigos_produto')
        .then(res => res.json())
        .then(dados => {
          listaArtigosComPrecos = Array.isArray(dados) ? dados : [];
          if (typeof callback === "function") callback();
        })
        .catch(err => {
          console.error('Erro ao carregar artigos:', err);
          listaArtigosComPrecos = [];
          if (typeof callback === "function") callback();
        });
    }

    function getTipoPrecoAtual() {
      const tabela = document.querySelector('input[name="tabelaPrecos"]:checked');
      if (!tabela) return "";
      const val = tabela.value || "";
      if (val.includes("7%"))  return "icms_7";
      if (val.includes("12%")) return "icms_12";
      if (val.includes("18%")) return "icms_18";
      if (val.includes("RET")) return "ret_mg";
      if (val.includes("LD"))  return "ld";
      return "";
    }

    function gerarOpcoesArtigo() {
      tipoPrecoAtual = getTipoPrecoAtual();
      return listaArtigosComPrecos.filter(a => (tipoPrecoAtual === 'ld') ? a.tabela === 'ld' : a.tabela === 'normal');
    }

    function atualizarTodasListasDeArtigos() {
      document.querySelectorAll('[id^="produto-"]').forEach(prodDiv => {
        const pid = prodDiv.id.replace('produto-', '');
        const artigoSelect = prodDiv.querySelector(\`select.artigo-select[data-produto="\${pid}"]\`);
        if (!artigoSelect) return;

        const artigoAtual = artigoSelect.value;
        artigoSelect.innerHTML = '<option value="">Selecione...</option>';
        gerarOpcoesArtigo().forEach(({ artigo }) => {
          const opt = document.createElement("option");
          opt.value = artigo;
          opt.textContent = artigo;
          artigoSelect.appendChild(opt);
        });
        if (artigoAtual) artigoSelect.value = artigoAtual;
      });
    }

    function atualizarTodosPrecosProdutos() {
      document.querySelectorAll('[id^="produto-"]').forEach(prodDiv => {
        const pid = prodDiv.id.replace('produto-', '');
        const artigoSelect = prodDiv.querySelector(\`select.artigo-select[data-produto="\${pid}"]\`);
        if (artigoSelect && artigoSelect.value) {
          preencherCodigoEPreco(pid, artigoSelect.value);
        }
      });
    }

    function adicionarProduto() {
      contadorProdutos++;
      const container = document.getElementById('produtos-container');
      if (!container) return;

      const produtoDiv = document.createElement('div');
      produtoDiv.className = 'border rounded p-3 mb-3';
      produtoDiv.id = \`produto-\${contadorProdutos}\`;

      produtoDiv.innerHTML = \`
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h6 class="mb-0">Produto \${contadorProdutos}</h6>
          <button type="button" class="btn btn-danger btn-sm" onclick="removerProduto(\${contadorProdutos})">üóëÔ∏è Remover</button>
        </div>
        <div class="row">
          <div class="col-md-3 mb-2">
            <label class="form-label">Artigo *</label>
            <select class="form-select artigo-select" data-produto="\${contadorProdutos}" required>
              <option value="">Selecione...</option>
            </select>
          </div>
          <div class="col-md-2 mb-2">
            <label class="form-label">C√≥digo</label>
            <input type="text" class="form-control codigo-input" data-produto="\${contadorProdutos}" readonly />
          </div>
          <div class="col-md-3 mb-2">
            <label class="form-label">Desenho/Cor *</label>
            <input type="text" class="form-control desenho-input" data-produto="\${contadorProdutos}" required />
          </div>
          <div class="col-md-2 mb-2">
            <label class="form-label">Metragem *</label>
            <input type="number" class="form-control metragem-input" data-produto="\${contadorProdutos}" min="0.01" step="0.01" required />
          </div>
          <div class="col-md-2 mb-2">
            <label class="form-label">Pre√ßo Unit√°rio</label>
            <input type="number" class="form-control preco-input" data-produto="\${contadorProdutos}" step="0.01" readonly />
          </div>
        </div>
        <div class="text-end">
          <strong>Subtotal: R$ <span class="subtotal" data-produto="\${contadorProdutos}">0.00</span></strong>
        </div>
      \`;
      container.appendChild(produtoDiv);

      const artigoSelect = produtoDiv.querySelector(\`select.artigo-select[data-produto="\${contadorProdutos}"]\`);
      artigoSelect.innerHTML = '<option value="">Selecione...</option>';
      gerarOpcoesArtigo().forEach(({ artigo }) => {
        const opt = document.createElement("option");
        opt.value = artigo;
        opt.textContent = artigo;
        artigoSelect.appendChild(opt);
      });

      adicionarEventListenersProduto(contadorProdutos);
    }

    function removerProduto(id) {
      const produto = document.getElementById(\`produto-\${id}\`);
      if (produto) {
        produto.remove();
        calcularTotal();
      }
    }

    function adicionarEventListenersProduto(id) {
      const artigoSelect = document.querySelector(\`select.artigo-select[data-produto="\${id}"]\`);
      if (artigoSelect) {
        artigoSelect.addEventListener('change', function() {
          preencherCodigoEPreco(id, this.value);
          calcularSubtotal(id);
        });
      }
      const metragemInput = document.querySelector(\`input.metragem-input[data-produto="\${id}"]\`);
      if (metragemInput) {
        metragemInput.addEventListener('input', function() {
          calcularSubtotal(id);
        });
      }
    }

    function preencherCodigoEPreco(id, artigoSelecionado) {
      tipoPrecoAtual = getTipoPrecoAtual();
      const artigoObj = listaArtigosComPrecos.find(a =>
        a.artigo === artigoSelecionado && (
          (tipoPrecoAtual === 'ld' && a.tabela === 'ld') ||
          (tipoPrecoAtual !== 'ld' && a.tabela === 'normal')
        )
      );
      const codigoInput = document.querySelector(\`input.codigo-input[data-produto="\${id}"]\`);
      const precoInput  = document.querySelector(\`input.preco-input[data-produto="\${id}"]\`);

      if (artigoObj) {
        if (codigoInput) codigoInput.value = artigoObj.codigo || '';
        let preco = '';
        if (tipoPrecoAtual === 'ld') {
          preco = artigoObj.precos.ld ?? '';
        } else {
          preco = artigoObj.precos[tipoPrecoAtual] ?? '';
        }
        if (precoInput) precoInput.value = (preco !== null && preco !== '' ? parseFloat(preco).toFixed(2) : '');
      } else {
        if (codigoInput) codigoInput.value = '';
        if (precoInput)  precoInput.value  = '';
      }
      calcularSubtotal(id);
    }

    function calcularSubtotal(produtoId) {
      const metragem = parseFloat(document.querySelector(\`input.metragem-input[data-produto="\${produtoId}"]\`)?.value) || 0;
      const preco    = parseFloat(document.querySelector(\`input.preco-input[data-produto="\${produtoId}"]\`)?.value)    || 0;
      const subtotal = metragem * preco;
      const span = document.querySelector(\`span.subtotal[data-produto="\${produtoId}"]\`);
      if (span) span.textContent = subtotal.toFixed(2);
      calcularTotal();
    }

    function calcularTotal() {
      let total = 0;
      document.querySelectorAll('.subtotal').forEach(span => {
        total += parseFloat(span.textContent) || 0;
      });
      const totalEl = document.getElementById('valorTotal');
      if (totalEl) totalEl.textContent = total.toFixed(2);
    }

    function wireTabelaPrecosRadios() {
      document.querySelectorAll('input[name="tabelaPrecos"]').forEach(radio => {
        radio.addEventListener('change', () => {
          tipoPrecoAtual = getTipoPrecoAtual();
          atualizarTodosPrecosProdutos();
          atualizarTodasListasDeArtigos();
        });
      });
    }

    // ============================= AUTOCOMPLETE CLIENTES =============================
    function wireAutocompleteClientes() {
      const input = document.getElementById('razaoSocial');
      const dropdown = document.getElementById('autocomplete-dropdown');
      if (!input || !dropdown) return;

      input.addEventListener('input', function(e) {
        const query = e.target.value.trim();
        clearTimeout(timeoutId);

        if (query.length < 1) {
          dropdown.style.display = 'none';
          limparDadosCliente();
          return;
        }
        timeoutId = setTimeout(() => { buscarClientes(query); }, 300);
      });

      document.addEventListener('click', function(e) {
        if (!e.target.closest('.autocomplete-container')) {
          dropdown.style.display = 'none';
        }
      });
    }

    function buscarClientes(query) {
      fetch(\`/api/buscar_clientes?q=\${encodeURIComponent(query)}\`)
        .then(response => response.json())
        .then(data => { mostrarResultados(data); })
        .catch(error => { console.error('Erro na busca de clientes:', error); });
    }

    function mostrarResultados(clientes) {
      const dropdown = document.getElementById('autocomplete-dropdown');
      if (!dropdown) return;
      dropdown.innerHTML = '';

      if (!clientes || clientes.length === 0) {
        dropdown.style.display = 'none';
        return;
      }

      clientes.forEach(cliente => {
        const item = document.createElement('div');
        item.className = 'autocomplete-item';
        item.innerHTML = \`
          <strong>\${cliente.razao_social}</strong><br/>
          <small style="color:#666;">CNPJ: \${cliente.cnpj}</small>
        \`;
        item.addEventListener('click', () => { selecionarCliente(cliente); });
        dropdown.appendChild(item);
      });
      dropdown.style.display = 'block';
    }

    function selecionarCliente(cliente) {
      const rz  = document.getElementById('razaoSocial');
      const cnpj= document.getElementById('cnpj');
      const tel = document.getElementById('telefone');
      if (rz)   rz.value   = cliente.razao_social || '';
      if (cnpj) cnpj.value = cliente.cnpj || '';
      if (tel)  tel.value  = cliente.telefone || '';
      const dropdown = document.getElementById('autocomplete-dropdown');
      if (dropdown) dropdown.style.display = 'none';
    }

    function limparDadosCliente() {
      const cnpj= document.getElementById('cnpj');
      const tel = document.getElementById('telefone');
      if (cnpj) cnpj.value = '';
      if (tel)  tel.value  = '';
    }

    // ============================= FORM/UX =============================
    function wireContadorObservacoes() {
      const obs = document.getElementById('observacoes');
      const counter = document.getElementById('contadorCaracteres');
      if (!obs || !counter) return;
      obs.addEventListener('input', function() { counter.textContent = this.value.length; });
    }

    function limparFormulario() {
      if (!confirm('Deseja realmente cancelar e limpar todos os dados?')) return;
      const form = document.getElementById('pedidoForm');
      if (form) form.reset();
      const container = document.getElementById('produtos-container');
      if (container) container.innerHTML = '';
      contadorProdutos = 0;
      calcularTotal();
      adicionarProduto(); // recoloca um item vazio
    }

    function wireSubmit() {
      const form = document.getElementById('pedidoForm');
      if (!form) return;
      form.addEventListener('submit', function(e) {
        e.preventDefault();

        if (document.querySelectorAll('[id^="produto-"]').length === 0) {
          alert('Adicione pelo menos um produto ao pedido!');
          return;
        }

        const dadosPedido = {
          nomeRepresentante: getVal('nomeRepresentante'),
          razaoSocial: getVal('razaoSocial'),
          cnpj: getVal('cnpj'),
          telefone: getVal('telefone'),
          prazoPagamento: getVal('prazoPagamento'),
          tabelaPrecos: document.querySelector('input[name="tabelaPrecos"]:checked')?.value || '',
          observacoes: getVal('observacoes'),
          produtos: [],
          valorTotal: parseFloat(document.getElementById('valorTotal')?.textContent || '0') || 0
        };

        document.querySelectorAll('[id^="produto-"]').forEach(produtoDiv => {
          const produtoId = produtoDiv.id.replace('produto-', '');
          const produto = {
            artigo:   produtoDiv.querySelector(\`select[data-produto="\${produtoId}"]\`)?.value || '',
            codigo:   produtoDiv.querySelector(\`input.codigo-input[data-produto="\${produtoId}"]\`)?.value || '',
            desenho_cor: produtoDiv.querySelector(\`input.desenho-input[data-produto="\${produtoId}"]\`)?.value || '',
            metragem: parseFloat(produtoDiv.querySelector(\`input.metragem-input[data-produto="\${produtoId}"]\`)?.value || '0') || 0,
            preco:    parseFloat(produtoDiv.querySelector(\`input.preco-input[data-produto="\${produtoId}"]\`)?.value || '0') || 0,
            subtotal: parseFloat(produtoDiv.querySelector(\`span.subtotal[data-produto="\${produtoId}"]\`)?.textContent || '0') || 0
          };
          dadosPedido.produtos.push(produto);
        });

        fetch('/submit_pedido', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(dadosPedido)
        })
        .then(r => r.json())
        .then(data => {
          if (data.sucesso) {
            alert(\`Pedido enviado com sucesso! N√∫mero: \${data.numero_pedido}\`);
            limparFormulario();
          } else {
            alert(\`Erro ao enviar pedido: \${data.erro || 'Falha desconhecida'}\`);
          }
        })
        .catch(err => {
          console.error('Erro ao enviar pedido:', err);
          alert('Erro ao enviar pedido. Tente novamente.');
        });
      });
    }

    // ============================= INICIALIZA√á√ÉO =============================
    window.addEventListener('load', function() {
      wireTabelaPrecosRadios();
      wireAutocompleteClientes();
      wireContadorObservacoes();
      wireSubmit();

      carregarArtigosDoBanco(() => {
        tipoPrecoAtual = getTipoPrecoAtual();
        adicionarProduto();
      });
    });
  </script>
</body>
</html>
